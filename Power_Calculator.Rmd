---
title: "Power_Calculator"
author: "Nasimeh, Anastasia"
date: "7/5/2022"
output: html_document
---

```{r setup, include=FALSE}

if (!requireNamespace("BiocManager", quietly = TRUE))
install.packages("BiocManager")
BiocManager::install(version = "3.15")
BiocManager::install("limma")
BiocManager::install()

library(limma)
library(CpGassoc)

```

```{r setup, include=FALSE}
#unzipping 

#import_data = function(zip_file){
#user_path = "/Users/sima/Documents/summer project/datsets/"
#print(user_path)
#unziped_files = unzip(zip_file, exdir = getwd())
#print(unziped_files)
#print(zip_file)
#return(unziped_files)
#}
#user_path = "/Users/sima/Documents/summer project/datsets/"
#temp = list.files(path=getwd(), pattern = "*.zip")
#print(temp)
#a = import_data(temp)
#simulations = apply(temp, import_data)

unzip_file = function(item){
#working_directory = getwd()

temp = list.files(path=getwd(), pattern = paste0("SimMethyl_run_",item))
list_of_txts<-unzip(temp,exdir = getwd()) #,list=TRUE
file1 = read.table(list_of_txts[1])
file2 = read.table(list_of_txts[2])
file3 = read.table(list_of_txts[3], header = TRUE)
workflow = list(file1, file2, file3)
return(workflow)
}

```

```{r setup, include=FALSE}
Get_all_zip = function(n_zip){
all_runs_output = list()
for (i #1:n_zip)
  i=1
  run = unzip_file(i)
  all_runs_output[[i]] = run
}
return(all_runs_output)

```

```{r setup, include=FALSE}
preprocess_simulated_data = function(all_runs_output, zip_order){
  
simulated_data = all_runs_output[[zip_order]][[1]]
parameters = all_runs_output[[zip_order]][[3]]
healthy_proportion = parameters$Value[parameters$Parameter == "Healthy proportion"]
n_healthy = ncol(simulated_data)*healthy_proportion
healthy = simulated_data[,1:n_healthy]
diseased = simulated_data[,(n_healthy+1):ncol(simulated_data)]

colnames(simulated_data)[(1:n_healthy)] = "Group1"
colnames(simulated_data)[(n_healthy+1):ncol(simulated_data)] = "Group2"
colnames(simulated_data) = factor(colnames(simulated_data))

return(preprocess_simulated_data)
}


```

```{r setup, include=FALSE}
calculate_means <- function (beta_values_matrix) {
  # check stop if not() to make sure there are no non numeric values.
  means <- rowMeans(beta_values_matrix, na.rm=TRUE)# if all values within a row are NA produces NaN
  means <- na.omit(means) #add handling of NAs if values in the the vector are NAs
  return(means)
}
healthy_mean = calculate_means(healthy)
diseased_mean = calculate_means(diseased)

#groupnames


```


```{r setup, include=FALSE}
#T.Test  #parametric

t_test = function(simulated_data){
phenotype = as.data.frame(colnames(simulated_data))
names(phenotype) = "Group"  
t_test_output <- cpg.assoc(beta.val=simulated_data, indep = phenotype$Group, logit.transform = TRUE) #indep = A vector containing the variable to be tested for association #logit.transform = transforming B-values to M-values 
t_test_Pvalue = t_test_output$results$P.value
return(t_test_Pvalue)
}



```

```{r setup, include=FALSE}
# #Kolmogorov-Smirnov Tests - non-parametric
#remember the measn for M-values

Ks_tes = function(Group1_mean, Group2_mean){
ks_test_output = ks.test(healthy_mean, diseased_mean)
return(ks_test_output)
}


```

```{r setup, include=FALSE}
#Limma #bayesian based 

limma_test = function(Beta_matrix){
# model.matrix(~ simulated_data$Group2) - by manually
Group1 <- ifelse(colnames(simulated_data)=="Group1", 1, 0)
Group2 <- ifelse(colnames(simulated_data)=="Group2", 1, 0)
design_matrix = as.data.frame(cbind(Group1,Group2)) 

contrast_matrix = makeContrasts(Diff = Group2 - Group1, levels = design_matrix)

#test 3 - limma 
fit1 <- lmFit(simulated_data, design_matrix)
fit2 <- contrasts.fit(fit1, contrast_matrix)
fit3 <- eBayes(fit2)
limma_output = as.data.frame(fit3)
limma_Pvalue = limma_output$p.value
return(limma_Pvalue)
}

```


```{r setup, include=FALSE}
#Needs to be fixed after returning from simulation
logit_transformation = function (Beta_matrix){
 Beta_matrix <- ifelse(as.matrix(Beta_matrix)>=1, 0.99, as.matrix(Beta_matrix))
 Beta_matrix <- ifelse(as.matrix(Beta_matrix)<=0, 0.00000000000000001, as.matrix(Beta_matrix))
  beta_transform = log2(Beta_matrix/(1-Beta_matrix))
  resturn(logit_transformation)
}

```

```{r setup, include=FALSE}

```

```{r setup, include=FALSE}

```
